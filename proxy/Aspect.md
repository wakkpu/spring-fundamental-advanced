### 자동 프록시 생성기의 기능
- `Aspect`를 보고 어드바이저로 변환해서 저장한다
- 어드바이저를 기반으로 프록시를 생성한다

### `@Aspect`를 어드바이저로 변환해서 저장하는 과정
1. 실행: 스프링 어플리케이션 로딩 시점에 자동 프록시 생성기를 호출한다
2. 모든 @Aspect 빈 조회: 자동 프록시 생성기는 스프링 컨테이너에서 @Aspect 어노테이션이 붙은 스프링 빈을 모두 조회한다
3. 어드바이저 생성: @Aspect 어드바이저 빌더를 통해 @Aspect 어노테이션 정보를 기반으로 어드바이저를 생성한다
4. @Aspect 기반 어드바이저 저장: 생성한 어드바이저를 @Aspect 어드바이저 빌더 내부에 저장한다

### 어드바이저를 기반으로 프록시 생성
1. 생성: 스프링 빈 대상이 되는 객체를 생성한다
2. 전달: 생성된 객체를 빈 저장소에 등록하기 직전에 빈 후처리기에 전달한다
3. 조회
   1. 어드바이저 빈 조회: 스프링 컨테이너에서 어드바이저 빈을 모두 조회한다
   2. @Aspect 어드바이저 조회: @Aspect 어드바이저 빌더 내부에 저장된 어드바이저를 모두 조회한다
4. 프록시 적용 대상 체크: 3-1, 3-2에서 조회한 어드바이저에 포함된 포인트컷을 사용해 해당 객체가 프록시를 적용할 대상인지 아닌지 판단한다. 이때 객체의 모든 메서드를 포인트컷에 매칭시켜 하나라도 조건을 만족하면 프록시 적용 대상이 된다.
5. 프록시 생성: 프록시 적용 대상이면 프록시를 생성하고 프록시를 반환한다. 그래서 프록시를 스프링 빈으로 등록한다. 만약 프록시 적용 대상이 아니라면 원본 객체를 반환해서 원본 객체를 스프링 빈으로 등록한다
6. 빈 등록: 반환된 객체는 스프링 빈으로 등록된다

---

### AOP 적용 방식
AOP를 사용하면 핵심 기능과 부가 기능이 코드상 완전히 분리되어서 관리된다.

그렇다면 AOP를 사용할 때 부가 기능 로직은 어떤 방식으로 실제 로직에 추가될 수 있을까?

크게 세 가지 방법이 있다.
- 컴파일 시점
- 클래스 로딩 시점
- 런타임 시점

### 컴파일 시점
`.java` 소스 코드를 컴파일러를 사용해서 `.class`를 만드는 시점에 부가 기능 로직을 추가할 수 있다.
이 때는 AspectJ가 제공하는 특별한 컴파일러를 사용해야 한다. 컴파일된 `.class`를 디컴파일해보면 Aspect 관련 호출 코드가 들어가있다.

Aspect 컴파일러는 Aspect를 확인해서 해당 클래스가 적용 대상인지 확인하고, 적용 대상인 경웨 부가 기능 로직을 추가한다.
이렇게 원본 로직에 부가 기능 로직이 추가되는 것을 위빙(Weaving)이라 한다.

### 컴파일 시점 - 단점
컴파일 시점에 부가 기능을 적용하려면 특별한 컴파일러도 필요하고 복잡하다

### 클래스 로딩 시점
자바를 실행하면 자바는 `.class` 파일을 JVM 내부의 클래스 로더에 보관한다. 이때 중간에서 `.class` 파일을 조작한 다음 JVM에 올릴 수 있다.
자바 언어는 `.class`를 JVM에 저장하기 전에 조작할 수 있는 기능을 제공한다. 참고로 수많은 모니터링 툴들이 이 방식을 사용한다. (java instrumentation)

### 클래스 로딩 시점 - 단점
로드 타임 위빙은 자바를 실행할 때 특별한 옵션(java -javaagent)을 통해 클래스 로더 조작기를 지정해야 하는데, 이 부분이 번거롭고 운영하기 어렵다.

### 런타임 시점
런타임 시점은 컴파일도 다 끝나고, 클래스 로더에 클래스도 다 올라가서 이미 자바가 실행되고 난 다음을 말한다. 자바의 main 메서드가 이미 실행된 다음이다.
따라서 자바 언어가 제공하는 범위 안에서 부가 기능을 적용해야 한다. 스프링과 같은 컨테이너의 도움을 받고 프록시와 DI, 빈 후처리기 같은 개념을 총동원해야 한다.
이렇게 하면 최종적으로 프록시를 통해 스프링 빈에 부가 기능을 적용할 수 있다.

---

### AOP 용어 정리

- 조인 포인트(Join Point)
  - 어드바이스가 적용될 수 있는 위치, 메소드 실행, 생성자 호출, 필드값 접근, static 메서드 접근 같은 프로그램 실행 중 지점
  - 조인 포인트는 추상적인 개념이다. AOP를 적용할 수 있는 모든 지점이라 생각하면 된다
  - 스프링 AOP는 프록시 방식을 사용하므로 조인 포인트는 항상 메소드 실행 지점으로 제한된다
- 포인트컷(Pointcut)
  - 조인 포인트 중에서도 어드바이스가 적용될 위치를 선별하는 기능
  - 주로 AspectJ 표현식을 사용해서 지정
  - 프록시를 사용하는 스프링 AOP는 메서드 실행 지점만 포인트컷으로 선별 가능
- 타겟(Target)
  - 어드바이스를 받는 객체, 포인트컷으로 결정
- 어드바이스(Advice)
  - 부가 기능
  - 특정 조인 포인트에서 Aspect에 의해 취해지는 조치
  - Around, Before, After와 같은 다양한 종류의 어드바이스가 있음
- 애스펙트(Aspect)
  - 어드바이스 + 포인트컷을 모듈화한 것
  - @Aspect를 생각하면 됨
  - 여러 어드바이스와 포인트컷이 함께 존재
- 어드바이저(Advisor)
  - 하나의 어드바이스와 하나의 포인트컷으로 구성
  - 스프링 AOP에서만 사용되는 특별한 용어
- 위빙(Weaving)
  - 포인트컷으로 결정한 타겟의 조인 포인트에 어드바이스를 적용하는 것
  - 위빙을 통해 핵심 기능 코드에 영향을 주지 않고 부가 기능을 추가할 수 있음
  - AOP 적용을 위해 애스펙트를 객체에 연결한 상태
- AOP 프록시
  - AOP 기능을 구현하기 위해 만든 프록시 객체, 스프링에서 AOP 프록시는 JDK 동적 프록시 또는 CGLIB 프록시이다